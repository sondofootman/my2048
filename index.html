<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>2048 Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      overscroll-behavior: none;
      touch-action: manipulation;
      background-color: #faf8ef;
      font-family: sans-serif;
    }
    .game-container {
      width: 405px; /* Reduced from 450px by 10% */
      margin: 0 auto;
      padding: 9px; /* Reduced from 10px by 10% */
      box-sizing: border-box;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 90px); /* Reduced from 100px by 10% */
      grid-gap: 9px; /* Reduced from 10px by 10% */
      padding: 13.5px; /* Reduced from 15px by 10% */
      background-color: #bbada0;
      border-radius: 5.4px; /* Reduced from 6px by 10% */
      position: relative;
      touch-action: none;
    }
    .cell {
      width: 90px; /* Reduced from 100px by 10% */
      height: 90px; /* Reduced from 100px by 10% */
      background-color: rgba(238, 228, 218, 0.35);
      border-radius: 2.7px; /* Reduced from 3px by 10% */
      aspect-ratio: 1;
    }
    .tile {
      position: absolute;
      width: 90px; /* Reduced from 100px by 10% */
      height: 90px; /* Reduced from 100px by 10% */
      border-radius: 2.7px; /* Reduced from 3px by 10% */
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 40.5px; /* Reduced from 45px by 10% */
      font-weight: bold;
      transition: all 0.1s ease-in-out;
      z-index: 10;
    }
    .tile-2 { background-color: #eee4da; color: #776e65; }
    .tile-4 { background-color: #ede0c8; color: #776e65; }
    .tile-8 { background-color: #f2b179; color: #f9f6f2; }
    .tile-16 { background-color: #f59563; color: #f9f6f2; }
    .tile-32 { background-color: #f67c5f; color: #f9f6f2; }
    .tile-64 { background-color: #f65e3b; color: #f9f6f2; }
    .tile-128 { background-color: #edcf72; color: #f9f6f2; font-size: 36px; } /* Reduced from 40px by 10% */
    .tile-256 { background-color: #edcc61; color: #f9f6f2; font-size: 36px; } /* Reduced from 40px by 10% */
    .tile-512 { background-color: #edc850; color: #f9f6f2; font-size: 36px; } /* Reduced from 40px by 10% */
    .tile-1024 { background-color: #edc53f; color: #f9f6f2; font-size: 31.5px; } /* Reduced from 35px by 10% */
    .tile-2048 { background-color: #edc22e; color: #f9f6f2; font-size: 31.5px; } /* Reduced from 35px by 10% */
    .game-over {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(238, 228, 218, 0.73);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      border-radius: 5.4px; /* Reduced from 6px by 10% */
    }
    .game-over-text {
      font-size: 54px; /* Reduced from 60px by 10% */
      font-weight: bold;
      color: #776e65;
      margin-bottom: 27px; /* Reduced from 30px by 10% */
    }
    .score-container {
      background-color: #bbada0;
      color: white;
      padding: 13.5px 22.5px; /* Reduced from 15px 25px by 10% */
      border-radius: 5.4px; /* Reduced from 6px by 10% */
      text-align: center;
      margin-bottom: 18px; /* Reduced from 20px by 10% */
    }
    .score-title {
      font-size: 14.4px; /* Reduced from 16px by 10% */
      font-weight: bold;
      text-transform: uppercase;
    }
    .score-value {
      font-size: 27px; /* Reduced from 30px by 10% */
      font-weight: bold;
    }
    .new-tile {
      animation: appear 0.2s;
    }
    @keyframes appear {
      0% { opacity: 0; transform: scale(0); }
      100% { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body class="font-sans">
  <div class="game-container">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
      <h1 class="text-5xl font-bold text-[#776e65]">2048</h1>
      <div class="flex gap-4 flex-wrap justify-center">
        <div class="score-container">
          <div class="score-title">Score</div>
          <div id="score" class="score-value">0</div>
        </div>
        <div class="score-container">
          <div class="score-title">Best</div>
          <div id="high-score" class="score-value">0</div>
        </div>
      </div>
    </div>
    <p class="text-[#776e65] mb-4 text-base text-center">
      Join numbers to reach the <strong>2048 tile!</strong><br/>
      <strong>Swipe</strong> to move tiles.
    </p>
    <div class="grid" id="grid">
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div id="game-over" class="game-over hidden">
        <div class="game-over-text">Game Over!</div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const GRID_SIZE = 4;
      let grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
      let score = 0;
      let highScore = localStorage.getItem("highScore") || 0;
      let gameOver = false;

      const gridElement = document.getElementById("grid");
      const scoreElement = document.getElementById("score");
      const highScoreElement = document.getElementById("high-score");
      const gameOverElement = document.getElementById("game-over");

      // Telegram Web App integration
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
      tg.MainButton.setText("New Game").show().onClick(initGame);

      function initGame() {
        grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
        score = 0;
        gameOver = false;
        updateScore();
        renderGrid();
        addRandomTile();
        addRandomTile();
        gameOverElement.classList.add("hidden");
      }

      function renderGrid() {
        document.querySelectorAll(".tile").forEach(tile => tile.remove());
        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            const value = grid[row][col];
            if (value !== 0) {
              const tile = document.createElement("div");
              tile.className = `tile tile-${value} new-tile`;
              tile.textContent = value;
              tile.style.top = `${13.5 + row * 99}px`; /* Reduced from 15 + row * 110px by 10% */
              tile.style.left = `${13.5 + col * 99}px`; /* Reduced from 15 + col * 110px by 10% */
              gridElement.appendChild(tile);
              setTimeout(() => tile.classList.remove("new-tile"), 200);
            }
          }
        }
      }

      function updateScore() {
        scoreElement.textContent = score;
        if (score > highScore) {
          highScore = score;
          localStorage.setItem("highScore", highScore);
        }
        highScoreElement.textContent = highScore;
      }

      function addRandomTile() {
        const emptyCells = [];
        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            if (grid[row][col] === 0) emptyCells.push({ row, col });
          }
        }
        if (emptyCells.length > 0) {
          const { row, col } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
          grid[row][col] = Math.random() < 0.9 ? 2 : 4;
        }
      }

      function checkWin() {
        if (grid.flat().includes(2048)) {
          gameOverElement.innerHTML = `<div class="game-over-text">You Won!</div>`;
          gameOverElement.classList.remove("hidden");
          gameOver = true;
          return true;
        }
        return false;
      }

      function checkGameOver() {
        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            if (grid[row][col] === 0) return false;
            if (col < GRID_SIZE - 1 && grid[row][col] === grid[row][col + 1]) return false;
            if (row < GRID_SIZE - 1 && grid[row][col] === grid[row + 1][col]) return false;
          }
        }
        gameOverElement.innerHTML = `<div class="game-over-text">Game Over!</div>`;
        gameOverElement.classList.remove("hidden");
        gameOver = true;
        return true;
      }

      function moveTiles(direction) {
        if (gameOver) return false;
        let moved = false;
        const newGrid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));

        if (direction === "up") {
          for (let col = 0; col < GRID_SIZE; col++) {
            let position = 0;
            for (let row = 0; row < GRID_SIZE; row++) {
              if (grid[row][col] !== 0) {
                if (newGrid[position][col] === 0) {
                  newGrid[position][col] = grid[row][col];
                } else if (newGrid[position][col] === grid[row][col]) {
                  newGrid[position][col] *= 2;
                  score += newGrid[position][col];
                  position++;
                } else {
                  position++;
                  newGrid[position][col] = grid[row][col];
                }
                moved = true;
              }
            }
          }
        } else if (direction === "down") {
          for (let col = 0; col < GRID_SIZE; col++) {
            let position = GRID_SIZE - 1;
            for (let row = GRID_SIZE - 1; row >= 0; row--) {
              if (grid[row][col] !== 0) {
                if (newGrid[position][col] === 0) {
                  newGrid[position][col] = grid[row][col];
                } else if (newGrid[position][col] === grid[row][col]) {
                  newGrid[position][col] *= 2;
                  score += newGrid[position][col];
                  position--;
                } else {
                  position--;
                  newGrid[position][col] = grid[row][col];
                }
                moved = true;
              }
            }
          }
        } else if (direction === "left") {
          for (let row = 0; row < GRID_SIZE; row++) {
            let position = 0;
            for (let col = 0; col < GRID_SIZE; col++) {
              if (grid[row][col] !== 0) {
                if (newGrid[row][position] === 0) {
                  newGrid[row][position] = grid[row][col];
                } else if (newGrid[row][position] === grid[row][col]) {
                  newGrid[row][position] *= 2;
                  score += newGrid[row][position];
                  position++;
                } else {
                  position++;
                  newGrid[row][position] = grid[row][col];
                }
                moved = true;
              }
            }
          }
        } else if (direction === "right") {
          for (let row = 0; row < GRID_SIZE; row++) {
            let position = GRID_SIZE - 1;
            for (let col = GRID_SIZE - 1; col >= 0; col--) {
              if (grid[row][col] !== 0) {
                if (newGrid[row][position] === 0) {
                  newGrid[row][position] = grid[row][col];
                } else if (newGrid[row][position] === grid[row][col]) {
                  newGrid[row][position] *= 2;
                  score += newGrid[row][position];
                  position--;
                } else {
                  position--;
                  newGrid[row][position] = grid[row][col];
                }
                moved = true;
              }
            }
          }
        }

        if (moved) {
          grid = newGrid;
          updateScore();
          addRandomTile();
          renderGrid();
          if (checkWin()) return;
          if (checkGameOver()) return;
        }
      }

      // Swipe handling
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;

      gridElement.addEventListener("touchstart", (e) => {
        e.preventDefault();
        touchStartX = e.touches[0].screenX;
        touchStartY = e.touches[0].screenY;
      }, { passive: false });

      gridElement.addEventListener("touchend", (e) => {
        e.preventDefault();
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        const dx = touchEndX - touchStartX;
        const dy = touchEndY - touchStartY;
        const threshold = 50;

        if (Math.abs(dx) > Math.abs(dy)) {
          if (dx > threshold) moveTiles("right");
          else if (dx < -threshold) moveTiles("left");
        } else {
          if (dy > threshold) moveTiles("down");
          else if (dy < -threshold) moveTiles("up");
        }
      }, { passive: false });

      initGame();
    });
  </script>
</body>
</html>
